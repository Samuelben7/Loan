<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento com Mercado Pago</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: auto;
            padding: 20px;
        }

        form {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-top: 15px;
            font-weight: bold;
        }

        .mp-input {
            margin-top: 5px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
            border-radius: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Pagamento com Mercado Pago</h1>

    <!-- Formulário para pagamento -->
    <form id="payment-form">
        <!-- Número do cartão -->
        <label for="cardNumber">Número do cartão</label>
        <div id="cardNumber" class="mp-input"></div>

        <!-- Data de vencimento -->
        <label for="cardExpiration">Data de vencimento (MM/AA)</label>
        <div id="cardExpiration" class="mp-input"></div>

        <!-- Código de segurança -->
        <label for="securityCode">Código de segurança</label>
        <div id="securityCode" class="mp-input"></div>

        <!-- Nome no cartão -->
        <label for="cardholderName">Nome do titular como aparece no cartão</label>
        <input type="text" id="cardholderName" placeholder="Maria Santos Pereira" required>

        <!-- Documento do titular -->
        <label for="cpf">CPF</label>
        <input type="text" id="cpf" name="cpf" placeholder="999.999.999-99" required>

        <!-- E-mail -->
        <label for="email">E-mail</label>
        <input type="email" id="email" name="email" placeholder="exemplo@email.com" required>

        <!-- Botão para enviar -->
        <button type="submit" id="submit">Pagar</button>
    </form>

    <!-- Mensagem de erro -->
    <div id="error-message" class="error-message"></div>

    <script>
        // Inicialize o SDK do Mercado Pago
        const mp = new MercadoPago('TEST-3d5f3539-a332-4773-bb6b-1060fb7939f0', { locale: 'pt-BR' });

        // Montar os campos sensíveis usando o SDK
        mp.fields.create('cardNumber', {
            placeholder: '1234 5678 9012 3456',
            style: {
                fontSize: '16px',
                padding: '10px',
                borderColor: '#ccc',
                borderRadius: '5px',
            },
        }).mount('cardNumber');

        mp.fields.create('expirationDate', {
            placeholder: 'MM/AA',
            style: {
                fontSize: '16px',
                padding: '10px',
                borderColor: '#ccc',
                borderRadius: '5px',
            },
        }).mount('cardExpiration');

        mp.fields.create('securityCode', {
            placeholder: '123',
            style: {
                fontSize: '16px',
                padding: '10px',
                borderColor: '#ccc',
                borderRadius: '5px',
            },
        }).mount('securityCode');

        // Adiciona evento para capturar o token
        const form = document.getElementById('payment-form');
        const errorMessageDiv = document.getElementById('error-message');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            errorMessageDiv.textContent = ''; // Limpar mensagens de erro

            const cardholderName = document.getElementById('cardholderName').value;
            const cpf = document.getElementById('cpf').value;
            const email = document.getElementById('email').value;

            try {
                // Valida os campos antes de gerar o token
                const validationResults = await mp.fields.validate();
                if (!validationResults.isValid) {
                    let errorMessages = 'Por favor, preencha os campos corretamente:\n';
                    for (const field in validationResults.fields) {
                        if (!validationResults.fields[field].isValid) {
                            errorMessages += `- ${validationResults.fields[field].message}\n`;
                        }
                    }
                    errorMessageDiv.textContent = errorMessages;
                    return;
                }

                // Gera o token do cartão
                const token = await mp.fields.createCardToken({
                    cardholderName,
                    identification: {
                        type: 'CPF',
                        number: cpf.replace(/\D/g, ''), // Remove máscara
                    },
                });

                console.log('Token gerado:', token.id);

                // Adiciona o token no formulário
                const tokenField = document.createElement('input');
                tokenField.setAttribute('type', 'hidden');
                tokenField.setAttribute('name', 'token');
                tokenField.setAttribute('value', token.id);
                form.appendChild(tokenField);

                // Submete o formulário
                form.submit();
            } catch (error) {
                console.error('Erro ao gerar token:', error);
                errorMessageDiv.textContent = 'Erro ao gerar token do cartão. Tente novamente.';
            }
        });
    </script>
</body>
</html>
